<!DOCTYPE html>
<html>

  <head>
    <title>Geo Toast</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
        width: 80%;
        float: left;
      }

      #sidebar {
        height: 100vh;
        width: 20%;

        float: left;
        background: #eee;

        overflow: auto;
      }

      .fade li {
        transition: all 0.8s ease-out;
        opacity: 0;
      }

      .fade li.show {
        opacity: 1;
      }

      #ordersList {
        padding: 20px;
        height: 100%;
      }

      .orderElement {
        margin-top: 2rem;
        padding-bottom: 2rem;
        padding-right: 1rem;
        padding-left: 1rem;
        list-style-type: none;
        border-bottom: 1px solid;
      }

      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>

    <div id="sidebar" class="fade">
      <ul id="ordersList">
      </ul>
    </div>

    <script>
      var map;
      var markersArray = new Array();
      var FIXED_NUM_VISIBLE_MARKERS = 50;
      var FIXED_MARKER_SIZE = true;

      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 41.2571, lng: -95.9951},
          zoom: 5
        });

        (function loop() {
          let rand = Math.round(Math.random() * (2500 - 500)) + 500;
          setTimeout(function() {
            orderFetcher();
            loop();  
          }, rand);
        }());
      }

      function orderFetcher() {
        $.getJSON("http://localhost:8080/orders/latest", function(latestOrder) {
          displayOrder(latestOrder);
        });
      }

      function displayOrder(order) {
        /*
         * Given an order in JSON format, drop an appropriate marker at the
         * position of the order and add it to the sidebar.
         */
        dropMarker(order);
        addToList(order);
      }

      function dropMarker(jsonPacket) {
        /*
         * Drops a marker on the map.
         */

        let icon = {
          scaledSize: new google.maps.Size(3*15.5, 3*30.2),
        }

        switch(jsonPacket.size) {
            case 'S':
              icon.url = "toast-pin-bronze.png";
              break;
            case 'M':
              icon.url = "toast-pin-silver.png";
              break;
            case 'L':
              icon.url = "toast-pin-gold.png";
              break;
        }

        if(!FIXED_MARKER_SIZE) {
          icon.scaledSize = new google.maps.Size(6*.155*jsonPacket.amount, 6*.302*jsonPacket.amount);
        }

        let marker = new google.maps.Marker({
          position: {
            lat: jsonPacket.address.latitude,
            lng: jsonPacket.address.longitude
          },
          animation: google.maps.Animation.DROP,
          map: map,
          icon: icon,
        });

        // Create the infowindow:
        let infowindow = new google.maps.InfoWindow({
          content: jsonPacket.address.name,
          maxWidth: 200
        });

        // Pop up the info window on mouseover and remove it on mouse exit.
        marker.addListener('mouseover', function() {
          infowindow.open(map, marker);
        });

        marker.addListener('mouseout', function() {
          infowindow.close();
        });

        // Finally add it to the markers queue and remove the oldes one if
        // necessary.
        markersArray.push(marker);

        if(markersArray.length >= FIXED_NUM_VISIBLE_MARKERS) {
          let markerToRemove = markersArray.shift();
          markerToRemove.setMap(null);
        }
      }

      function addToList(order) {
        /*
         * Adds an order to the sidebar list of orders coming in.
         */
        let sidebar = document.getElementById("sidebar");
        let orderElementNode = document.createElement("li");

        orderElementNode.className = "orderElement";
        
        orderElementNode.innerHTML += "An order for $" + order.amount;
        orderElementNode.innerHTML += " came from " + order.guests;
        orderElementNode.innerHTML += " guests at " + order.address.name;
        
        sidebar.insertBefore(orderElementNode, sidebar.firstChild);

        setTimeout(function() {
          orderElementNode.className += " show";
        }, 100);
      }

      function hideSidebar() {
        $("#sidebar").hide();
        $("#map").width("100%");
      }

      function showSidebar() {
        $("#sidebar").show();
        $("#map").width("80%");
      }

    </script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD2RnB1rvhs-Zat0-R6tcZ2ExnK0aItnvg&callback=initMap"
    async defer></script>
  </body>

</html>
